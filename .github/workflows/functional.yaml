name: Functional tests

on:
  workflow_call:

jobs:
  functional_test:
    name: Operator functional tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3

      - name: Deploy devstack
        uses: EmilienM/devstack-action@v0.15

      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3

      - name: Install k3s
        run: |
          set -eo pipefail
          curl -sfL https://get.k3s.io | bash -s - --disable traefik
          mkdir $HOME/.kube
          sudo cp /etc/rancher/k3s/k3s.yaml $HOME/.kube/config
          sudo chown $USER $HOME/.kube/config

      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3

      - name: Install gomplate
        run: |
          go install github.com/hairyhenderson/gomplate/v4/cmd/gomplate@latest
          gomplate --version

      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3

      - name: Run functional tests
        timeout-minutes: 15
        run: |
          source devstack/openrc demo demo
          tools/functional_test.sh
